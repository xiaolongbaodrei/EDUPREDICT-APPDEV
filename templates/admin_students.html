{% extends 'base.html' %}

{% block content %}
<div class="card card-custom shadow-sm mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h3 class="card-title mb-0">Manage Students</h3>
    <div class="d-flex gap-2 align-items-center">
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('import_csv') }}">Import CSV</a>
      {% include '_back_button.html' %}
    </div>
  </div>
  <div class="card-body">
    <form method="get" class="d-flex gap-2 mb-3 align-items-center flex-wrap">
      <input name="q" class="form-control form-control-sm" placeholder="Search by name..." value="{{ q or '' }}">
      <select name="section" class="form-select form-select-sm" style="max-width:220px">
        <option value="All" {% if selected_section == 'All' %}selected{% endif %}>All sections</option>
        {% for sec in sections_list %}
          <option value="{{ sec }}" {% if selected_section == sec %}selected{% endif %}>{{ sec }}</option>
        {% endfor %}
      </select>
      <select name="subject" class="form-select form-select-sm" style="max-width:220px">
        <option value="All" {% if selected_subject == 'All' %}selected{% endif %}>All subjects</option>
        {% for subj in subjects_list %}
          <option value="{{ subj }}" {% if selected_subject == subj %}selected{% endif %}>{{ subj }}</option>
        {% endfor %}
      </select>
      <select name="risk" class="form-select form-select-sm" style="max-width:220px">
        <option value="All" {% if selected_risk == 'All' %}selected{% endif %}>All risk</option>
        {% for r in risk_list %}
          <option value="{{ r }}" {% if selected_risk == r %}selected{% endif %}>{{ r }}</option>
        {% endfor %}
      </select>
      <div class="ms-auto d-flex gap-2">
        <button class="btn btn-sm btn-primary" type="submit">Filter</button>
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('manage_students') }}">Clear</a>
      </div>
    </form>

    <div class="table-responsive">
  <table class="table table-striped table-sm">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Section</th>
        <th>Subject</th>
        <th>Attendance</th>
        <th>Activities</th>
        <th>Quizzes</th>
        <th>WW</th>
        <th>PT</th>
        <th>Exam</th>
        <th>Final Grade</th>
        <th>Risk</th>
        <th>Added by</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
    {% for s in students %}
    <tr>
      <td>{{ s.id }}</td>
      <td>{{ s.name }}</td>
      <td>{{ s.section or '-' }}</td>
      <td>{{ s.subject or '-' }}</td>
      <td>{{ '%.2f'|format(s.attendance) if s.attendance is not none else '-' }}</td>
      <td>{{ '%.2f'|format(s.activities) if s.activities is not none else '-' }}</td>
      <td>{{ '%.2f'|format(s.quizzes) if s.quizzes is not none else '-' }}</td>
      <td>{{ '%.2f'|format(s.written_works) if s.written_works is not none else '-' }}</td>
      <td>{{ '%.2f'|format(s.performance_task) if s.performance_task is not none else '-' }}</td>
      <td>{{ '%.2f'|format(s.exam) if s.exam is not none else '-' }}</td>
      <td>{{ '%.2f'|format(s.final_grade) if s.final_grade is not none else '-' }}</td>
      <td>
        {% if s.risk == 'High Risk' %}
          <span class="badge bg-danger">{{ s.risk }}</span>
        {% elif s.risk == 'Low Risk' %}
          <span class="badge bg-success">{{ s.risk }}</span>
        {% else %}
          <span class="badge bg-secondary">{{ s.risk }}</span>
        {% endif %}
      </td>
      <td>{{ s.added_by }}</td>
      <td class="actions-cell text-end">
        {% if session.get('user') == s.added_by %}
          <div class="actions-wrap d-inline-flex align-items-center gap-2 justify-content-end flex-nowrap">
            <a class="btn btn-sm btn-outline-primary btn-action" href="{{ url_for('edit_student', student_id=s.id) }}"><span class="me-1">‚úèÔ∏è</span>Edit</a>
            <form method="post" action="{{ url_for('delete_student', student_id=s.id) }}" class="m-0 confirmable" data-confirm="Delete student {name}?">
              <input type="hidden" name="_requires_confirm" value="1">
              <button class="btn btn-sm btn-outline-danger btn-action" type="submit"><span class="me-1">üóëÔ∏è</span>Delete</button>
            </form>
          </div>
        {% else %}
          <span class="text-muted">‚Äî</span>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

{% if total_pages and total_pages > 1 %}
  <div class="d-flex justify-content-between align-items-center mt-3">
    <div class="small text-muted">Showing {{ (page-1)*per_page + 1 }} - {{ (page-1)*per_page + students|length }} of {{ total }}</div>
    <nav aria-label="Page navigation">
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item {% if page <= 1 %}disabled{% endif %}"><a class="page-link" href="{{ url_for('manage_students', q=q, section=selected_section, subject=selected_subject, risk=selected_risk, page=page-1) }}">Previous</a></li>
        {% for p in range(1, total_pages+1) %}
          <li class="page-item {% if p == page %}active{% endif %}"><a class="page-link" href="{{ url_for('manage_students', q=q, section=selected_section, subject=selected_subject, risk=selected_risk, page=p) }}">{{ p }}</a></li>
        {% endfor %}
        <li class="page-item {% if page >= total_pages %}disabled{% endif %}"><a class="page-link" href="{{ url_for('manage_students', q=q, section=selected_section, subject=selected_subject, risk=selected_risk, page=page+1) }}">Next</a></li>
      </ul>
    </nav>
  </div>
{% endif %} 
{% endblock %}